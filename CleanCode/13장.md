# 13장. 동시성
- 동시성과 깔끔한 코드는 양립하기 어렵다.
- 동시성을 테스트하는 방법과 문제점 역시 논할 예정
#### 동시성이 필요한 이유?
- 동시성은 결합(coupling)을 없애는 전략이다.
- 예시 > 서블릿
  - 서블릿은 웹 혹은 EJB 컨테이너라는 우산 아래서 돌아가는데, 이들 컨테이너는 동시성을 부분적으로 관리함.
  - 서블릿 프로그래머는 동시성을 정확히 구현하도록 각별한 주의와 노력을 기울여야 한다.
- 동시성과 관련한 미신과 오해
  - 동시성은 항상 성능을 높여준다.(x)
  - 동시성을 구현해도 설계는 변하지 않는다.(x)
  - 웹 또는 EJB 컨테이너를 사용하면 동시성을 이해할 필요가 없다.(x)
- 동시서이과 관련된 타당한 생각
  - 동시성은 다소 부하를 유발한다.
  - 동시성은 복잡하다.
  - 일반적으로 동시성 버그는 재현하기 어렵다.
  - 동시성을 구현하려면 흔히 근본적인 설계 전략을 재고해야 한다.
#### 동시성 방어 원칙
- 단일 책임 원칙(Single Responsibility Principle)
  - 주어진 메서드/클래스/컴포넌트를 변경할 이유가 하나여야 한다는 원칙
  - 동시성 코드는 다른 코드와 분리하자!
- 따름 정리(corollary) : 자료 범위를 제한하라
  - critical section을 synchronized 키워드로 보호함
  - 자료를 캡슐화하고, 공유 자료를 최대한 줄이자
- 따름 정리: 자료 사본을 사용하라
  - 객체를 복사해 읽기 전용으로 사용하는 방법도 있음 -> 복사 시간, 부하를 고려하자
- 따름 정리: 스레드는 가능한 독립적으로 구현하라
  - 다른 스레드와 자료를 공유하지 않았으면 한다
#### 라이브러리를 이해하라
- 스레드 환경에 안전한 컬렉션
  - java.util.concurrent 패키지 -> ConcurrentHashMap
#### 실행 모델을 이해하라
- 한정된 자원 : db 연결, 길이가 일정한 읽기/쓰기 버퍼
- 상호 배제 : 공유 자원 사용 하는 경우
- 기아(Starvation) : 영원히 자원을 기다림
- 데드락 : 여러 스레드가 서로가 끝나기를 기다린다
- 라이브락(Livelock) : 락을 거는 단계에서 각 스레드가 서로를 방해한다.
- 생산자-소비자(Producer-Consumer)
  - 생산자 스레드와 소비자 스레드가 사용하는 대기열은 한정된 자원
- 읽기-쓰기(Reader-Writers)
- 식사하는 철학자들(Dining Philosophers)
  - 주의해서 설계하지않으면 데드락, 라이브락, 처리율 저하, 효율성 저하 등을 겪는다.
#### 동기화하는 메서드 사이에 존재하는 의존성을 이해하라
- 공유 클래스 하나에 동기화된 메서드가 여럿이라면 구현이 올바른지 다시 한 번 확인해야 한다
- 공유 객체 하나에는 메서드 하나만 사용하라
#### 동기화하는 부분을 작게 만들어라
- 필요 이상으로 임계영역 크기를 키우면 스레드 간에 경쟁이 늘어나고 프로그램 성능이 떨어진다.
#### 올바른 종료 코드는 구현하기 어렵다.
#### 스레드 코드 테스트하기
- 문제를 노출하는 테스트 케이스를 작성하라
- 말이 안 되는 실패는 잠정적인 스레드 문제로 취급하라
  - 실패를 재현하기 아주 어려워, 많은 개발자가 우주선(cosmicray), 하드웨어 문제, 단순한 일회성 문제로 치부하고 무시함
  - 일회성 문제란 존재하지 않는다고 가정하는 편이 안전하다
  - 일회성 문제를 계속 무시한다면 잘못된 코드 위에 코드가 계속 쌓인다
  - 단, 시스템 실패를 일회성이라 치부하지 마라
- 다중 스레드를 고려하지 않은 순차 코드부터 제대로 돌게 만들자.
  - 스레드 환경 밖에서 코드가 제대로 도는지 반드시 확인한다
- 프로세서 수보다 많은 스레드를 돌려보라
  - 시스템이 스레드를 스와핑할 때도 문제가 발생한다
- 코드에 보조 코드를 넣어 돌려라. 강제로 실패를 일으키게 해보라
  - 코드에 보조 코드를 추가하는 방법
  - 직접 구현하기
    - wait(), sleep(), yield() => 코드가 실행되는 경로가 바뀜, priority()
  - 자동화
    - 보조 코드를 자동으로 추가하려면 AOF(Aspect-Oriented Framework), CGLIB, ASM 등과 같은 도구 사용
  - ThreadJigglePoing.jiggle() 호출 -> 무작위로 sleep이나 yield 호출!
  - 코드를 흔드는 이유는 스레드를 매번 다른 순서로 실행하기 위해!
#### 결론
- 다중 스레드 코드를 짜려면 각별히 깨끗하게 코드를 짜야 한다.
- POJO를 사용해 스레드를 아는 코드와 스레드를 모르는 코드를 분리한다
- 스레드 코드는 많은 플랫폼에서 많은 설정으로 반복해서 계속 테스트해야 한다!