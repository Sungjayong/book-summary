# 11장. CQRS

## 11.1 단일 모델의 단점

- 주문 내역 조회 기능을 구현하려면 Order에서 주문 정보를 가져와야 하고, Product에서 상품 이름을 가져와야 하고, Member에서 회원 이름과 ID를 가져와야 한다.
- 조회 화면 특성상 조회 속도가 빠를수록 좋은데 여러 애그리거트의 데이터가 필요하면 구현 방법을 고민해야 한다.
- 이런 고민의 이유는 시스템 상태를 변경할 때와 조회할 때 단일 도메인 모델을 사용하기 때문
- ORM 기법은 도메인 상태 변경 기능을 구현하는 데는 적합하지만 주문 상세 조회 화면처럼 여러 애그리거트에서 데이터를 가져와 출력하는 기능을 구현하기에는 고려할 게 많음
- 이에 해결법으로 **상태 변경을 위한 모델과 조회를 위한 모델을 분리하는 것**

## 11.2 CQRS

- 시스템이 제공하는 기능 
  - 상태를 변경하는 기능(배송지 정보 변경, 새로운 주문 생성, 회원 암호 변경)
  - 사용자 입장에서 상태 정보를 조회하는 기능(주문 상세 내역 보기, 회원 정보 보기, 판매 통계 보기)
- 상태를 변경하는 범위와 상태를 조회하는 범위가 정확하게 일치하기 않기 때문에 단일 모델로 두 종류의 기능을 구현하면 모델이 불필요하게 복잡해진다.
- Command Query Responsibility Segregation
  - 상태를 변경하는 명령을 위한 모델과 상태를 제공하는 조회를 위한 모델을 분리하는 패턴

- 복잡한 도메인에 적합.

- CQRS를 사용하면 각 모델에 맞는 구현 기술을 선택할 수 있다.

  - 도메인 모델을 구현하기에 적당한 JPA를 사용해서 구현하고, 조회 모델은 DB테이블에서 SQL로 데이터를 조회할 때 좋은 마이바티스를 사용해서 구현하면 된다.

    <img src="/Users/seongjayong/Library/Application Support/typora-user-images/image-20220805174718729.png" alt="image-20220805174718729" style="zoom:50%;" />

- 명령 모델과 조회 모델의 설계 예

  <img src="/Users/seongjayong/Library/Application Support/typora-user-images/image-20220805174822941.png" alt="image-20220805174822941" style="zoom:50%;" />

  - 상태 변경을 위한 명령 모델은 객체를 기반으로 한 도메인 모델을 이용해서 구현함
  - 반면 조회 모델은 주문 요약 목록을 제공할 때 필요한 정보를 담고 있는 데이터 타입을 이용

- 두 데이터 저장소 간 데이터 동기화는 10장에서 배운 이벤트를 활용해서 처리

- 명령 모델과 조회 모델이 서로 다른 데이터 저장소를 사용할 경우 데이터 동기화 시점에 따라 구현 방식이 달라질 수 있다.

- 서로 다른 저장소의 데이터를 특정 식나 안에만 동기화해도 된다면 비동기로 데이터를 전송하면 된다

### 11.2.1 웹과 CQRS

- 일반적인 웹 서비스는 상태를 변경하는 요청보다 상태를 조회하는 요청이 많다.
- 조회 성능을 높이기 위해 다양한 기법을 사용하는데, 기본적으로 쿼리를 최적화해서 쿼리 실행 속도 자체를 높이고, 메모리에 조회 데이터를 캐싱해서 응답 속도를 높이기도 한다.
- 메모리에 캐싱하는 데이터는 DB에 보관된 데이터를 그대로 저장하기보다는 화면에 맞는 모양으로 변환한 데이터를 캐싱 할 때 성능에 더 유리하다. => 조회 전용 모델을 캐싱하는 것!

### 11.2.3 CQRS 장단점

- 장점
  - 명령 모델을 구현할 때 도메인 자체에 집중할 수 있다는 점 -> 조회 성능을 위한 코드가 명령 모델에 없으므로 도메인 로직을 구현하는 데 집중할 수 있다.
  - 조회 성능 향상에 유리함. 조회 단위로 캐시 기술을 적용할 수 있고, 조회에 특화된 쿼리를 마음대로 사용할 수도 있다.
- 단점
  - 구현해야 할 코드가 더 많다.
  - 더 많은 구현 기술이 필요하다.
- 이러한 장단점을 고려해서 CQRS 패턴을 도입할지 여부를 결정해야 한다. 도메인이 복잡하지 않은데 CQRS를 도입하면 두 모델 유지 비용만 높아진다.