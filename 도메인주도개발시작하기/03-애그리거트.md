# 3장. 애그리거트

#### 3.1 애그리거트

- 상위 수준 개념을 이용해서 전체 모델을 정리하면 전반적인 관계를 이해하는 데 도움이 된다.

<img src="/Users/jayo/Library/Application Support/typora-user-images/image-20220708164740486.png" alt="image-20220708164740486" style="zoom:67%;" />

- 상위 수준 모델을 개별 객체 단위로 다시 그려보면 아래와 같다.

  <img src="/Users/jayo/Library/Application Support/typora-user-images/image-20220708171045468.png" alt="image-20220708171045468" style="zoom:50%;" />

- 백 개 이상의 테이블을 한 장의 ERD(Entity Relationship Diagram)에 모두 표시하면 개별 테이블 간의 관계를 파악하느라 큰 틀에서 데이터 구조를 이해하는 데 어려움을 겪게되는 것처럼, 도메인 객체 모델이 복잡해지면 개별 구성요소 위조로 모델을 이해하게 되고 전반적인 구조나 큰 수준에서 도메인 간의 관계를 파악하기 어려워진다.

- 복잡한 도메인을 이해하고 관리하기 쉬운 단위로 만들려면 상위 수준에서 모델을 조망할 수 있는 방법이 필요한데, 그 방법이 바로 애그리거트다.

- 위 모델을 애그리거트 단위로 묶어서 다시 표현해보았다.

  <img src="/Users/jayo/Library/Application Support/typora-user-images/image-20220708172512461.png" alt="image-20220708172512461" style="zoom:50%;" />

- 경계를 설정할 때 기본이 되는 것이 도메인 규칙과 요구사항이다.
- 도메인 규칙에 따라 함께 생성되는 구성요소는 한 애그리거트에 속할 가능성이 높다.
  - 주문할 상품 개수, 배송지 정보, 주문자 정보는 주문 시점에 함께 생성되므로 이들은 한 애그리거트에 속한다.
- 흔히 'A가 B를 갖는다'로 설계할 수 있는 요구사항이 있다면 A와 B를 한 애그리거트로 묶어 생각하기 쉽다.
- 하지만 항상 그런것도 아니다.
  - 상품 상세 페이지에 들어가면 상품 상세 정보와 함께 리뷰 내용을 보여줘야 한다는 요구사항이 있을 때 Product 엔티티와 Review 엔티티가 한 애그리거트에 속한다고 생각할 수 있다.
  - 하지만 Product와 Review는 함께 생성되지 않고, 함께 변경되지도 않는다.
  - 게다가 Product를 변경하는 주체가 상품 담당자라면 Review를 생성하고 변경하는 주체는 고객이다.
  - Review의 변경이 Product에 영향을 주지 않고 반대로 Product의 변경이 Review에 영향을 주지 않기 때문에 다른 애그리거트에 속하게 하는 것이 낫다.

#### 3.2 애그리거트 루트

- 주문 애그리거트는 다음을 포함한다.
  - 총 금액인 totalAmounts를 갖고 있는 Order 엔티티
  - 개별 구매 상품의 개수인 quantity와 금액인 price를 갖고 있는 OrderLine 밸류
- 구매할 상품의 개수를 변경하면 OrderLine, Order 둘 다 변경 됨.
  - 주문 총 금액은 개별 상품의 주문 개수 * 가격의 합 이다.
- 애그리거트에 속한 모든 객체가 일관된 상태를 유지하려면 애그리거트 전체를 관리할 주체가 필요한데, 이 책임을 지는 것이 바로 애그리거트의 루트 엔티티이다.
- 애그리거트에 속한 객체는 애그리거트 루트 엔티티에 직접 또는 간접적으로 속하게 된다.
- 주문 애그리거트에서 루트 역할을 하는 엔티티는 Order이며, OrderLine, ShippingInfo, Orderer 등 주문 애그리거트에 속한 모델은 Order에 직접 또는 간접적으로 속한다.